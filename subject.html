<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Subject — PeakPrep</title>
  <link rel="stylesheet" href="/assets/css/style.css" />
</head>
<body>
  <header class="site-header">
    <div class="navbar container">
      <a class="brand" href="/index.html">PeakPrep</a>
      <nav class="nav">
        <a href="/index.html">Home</a>
        <a href="/levels/igcse.html">IGCSE</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h1 id="page-title">Subject</h1>
      <div class="card">
        <div class="card-body">
          <label for="topicSelect">Choose topic</label>
          <select id="topicSelect"></select>
        </div>
      </div>
    </section>

    <section id="qas">
      <h2>Q&As</h2>
      <div id="qa-grid"></div>
    </section>
    <section id="notes">
      <h2>Notes</h2>
      <div id="notes-grid"></div>
    </section>
    <section id="videos">
      <h2>Videos</h2>
      <div id="videos-grid"></div>
    </section>
    <section id="papers">
      <h2>Papers</h2>
      <div id="papers-list"></div>
    </section>
  </main>

  <footer>
    <p>© <span id="year"></span> PeakPrep.</p>
  </footer>

  <script type="module">
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    const params = new URLSearchParams(location.search);
    const level = (params.get('level') || 'IGCSE').toUpperCase();
    const subject = params.get('subject') || 'Mathematics';

    const topicSelect = document.getElementById('topicSelect');
    const pageTitle = document.getElementById('page-title');
    pageTitle.textContent = subject;

    // Load topics JSON and populate dropdown
    async function loadTopics() {
      try {
        const res = await fetch('/assets/data/topics.json');
        if (!res.ok) throw new Error('Failed to fetch topics.json');
        const allTopics = await res.json();

        let subTopics = [];

        // ✅ Case 1: subject is a direct key (Accounting, Business Studies, etc.)
        if (allTopics[subject]) {
          const subjBlock = allTopics[subject];
          for (const examCode in subjBlock) {
            if (Array.isArray(subjBlock[examCode])) {
              subTopics.push(...subjBlock[examCode]);
            }
          }
        }

        // ✅ Case 2: subject lives under Languages
        if (!subTopics.length && allTopics["Languages"]) {
          const langs = allTopics["Languages"];
          if (langs[subject]) {
            const langBlock = langs[subject];
            for (const examCode in langBlock) {
              if (Array.isArray(langBlock[examCode])) {
                subTopics.push(...langBlock[examCode]);
              }
            }
          }
        }

        // Fallback
        if (!subTopics.length) {
          subTopics = ['General'];
        }

        // Populate dropdown
        topicSelect.innerHTML = subTopics
          .map(t => `<option value="${t}">${t}</option>`)
          .join('');

        // Render initial
        updateAll(subTopics[0]);
      } catch (e) {
        console.error(e);
        topicSelect.innerHTML = `<option value="General">General</option>`;
        updateAll('General');
      }
    }

    function trackVisit(type, topic) {
      try {
        const key = 'pp:activity';
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        list.unshift({ level, subject, type, topic, ts: Date.now() });
        localStorage.setItem(key, JSON.stringify(list.slice(0, 50)));
      } catch {}
    }

    function renderQAs(topic) {
      document.getElementById('qa-grid').innerHTML = `
        <div class="card"><div class="card-body">
          <h3>${subject} — ${topic}</h3>
          <button onclick="trackVisit('qas', '${topic}')">Open Q&A</button>
        </div></div>`;
    }

    function renderNotes(topic) {
      document.getElementById('notes-grid').innerHTML = `
        <div class="card"><div class="card-body">
          <h3>${subject} — ${topic}</h3>
          <button onclick="trackVisit('notes', '${topic}')">Open Notes</button>
        </div></div>`;
    }

    function renderVideos(topic) {
      document.getElementById('videos-grid').innerHTML = `
        <div class="card"><div class="card-body">
          <h3>${subject} — ${topic}</h3>
          <button onclick="trackVisit('videos', '${topic}')">Watch Video</button>
        </div></div>`;
    }

    function renderPapers(topic) {
      document.getElementById('papers-list').innerHTML = `
        <div class="card"><div class="card-body">
          <h3>${subject} — ${topic}</h3>
          <button onclick="trackVisit('papers', '${topic}')">View Papers</button>
        </div></div>`;
    }

    function updateAll(topic) {
      renderQAs(topic);
      renderNotes(topic);
      renderVideos(topic);
      renderPapers(topic);
    }

    topicSelect.addEventListener('change', () => updateAll(topicSelect.value));

    loadTopics();
  </script>
</body>
</html>
